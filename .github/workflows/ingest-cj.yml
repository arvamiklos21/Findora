name: Ingest CJ feeds

on:
  workflow_dispatch:
  schedule:
    - cron: "20 7,17 * * *"   # példa: 08:20 és 18:20 HU idő

permissions:
  contents: write

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -e
          pip install --upgrade pip
          pip install requests

      # ----- CJ eOptika feed letöltés (hibánál is megy tovább) -----
      - name: Download CJ eOptika feed
        env:
          CJ_EOPTIKA_URL: ${{ secrets.CJ_EOPTIKA_URL }}
        run: |
          set -e
          mkdir -p cj-eoptika-feed
          if [ -n "$CJ_EOPTIKA_URL" ]; then
            curl -L "$CJ_EOPTIKA_URL" -o eoptika.zip || { echo "WARN: eOptika ZIP letöltési hiba"; exit 0; }
            unzip -o eoptika.zip -d cj-eoptika-feed || echo "WARN: eOptika unzip hiba – lehet, hogy nem ZIP vagy üres"
          else
            echo "WARN: CJ_EOPTIKA_URL nincs beállítva – eOptika feed kihagyva"
          fi

      # ----- CJ Kärcher feed -----
      - name: Download CJ Karcher feed
        env:
          CJ_KARCHER_URL: ${{ secrets.CJ_KARCHER_URL }}
        run: |
          set -e
          mkdir -p cj-karcher-feed
          if [ -n "$CJ_KARCHER_URL" ]; then
            curl -L "$CJ_KARCHER_URL" -o karcher.zip || { echo "WARN: Karcher ZIP letöltési hiba"; exit 0; }
            unzip -o karcher.zip -d cj-karcher-feed || echo "WARN: Karcher unzip hiba – lehet, hogy nem ZIP vagy üres"
          else
            echo "WARN: CJ_KARCHER_URL nincs beállítva – Karcher feed kihagyva"
          fi

      # ----- CJ JátékNet feed -----
      - name: Download CJ Jateknet feed
        env:
          CJ_JATEKNET_URL: ${{ secrets.CJ_JATEKNET_URL }}
        run: |
          set -e
          mkdir -p cj-jateknet-feed
          if [ -n "$CJ_JATEKNET_URL" ]; then
            curl -L "$CJ_JATEKNET_URL" -o jateknet.zip || { echo "WARN: Jateknet ZIP letöltési hiba"; exit 0; }
            unzip -o jateknet.zip -d cj-jateknet-feed || echo "WARN: Jateknet unzip hiba – lehet, hogy nem ZIP vagy üres"
          else
            echo "WARN: CJ_JATEKNET_URL nincs beállítva – Jateknet feed kihagyva"
          fi

      - name: Build CJ feeds (eOptika, Karcher, Jateknet)
        run: |
          set -e
          python scripts/build_cj_eoptika.py  || echo "WARN: CJ eOptika build hiba (helykitöltők ha a script úgy van megírva)"
          python scripts/build_cj_karcher.py  || echo "WARN: CJ Karcher build hiba"
          python scripts/build_cj_jateknet.py || echo "WARN: CJ Jateknet build hiba"

          echo "Tree under docs/feeds:"
          ls -R docs/feeds || true

      - name: Commit & push to main
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # mindig friss origin/main alapra dolgozunk
          git fetch origin
          git checkout main
          git reset --hard origin/main

          git add docs/feeds/cj-eoptika docs/feeds/cj-karcher docs/feeds/cj-jateknet || true

          git commit -m "CJ feeds: update eOptika, Karcher, Jateknet" || echo "No changes"
          git push origin main
