<script>
  // ===== TCHIBO FEED ‚Äì statikus JSON + deeplink Worker =====
  const API_BASE = location.hostname.endsWith('findora.hu') ? 'https://www.findora.hu' : location.origin;
  const tchiboDl = u => `${API_BASE}/api/dl?u=${encodeURIComponent(u)}&p=tchibo`;

  const TCH_META_URL = '/feeds/tchibo/meta.json';
  const TCH_PAGE_URL = (n) => `/feeds/tchibo/page-${String(n).padStart(4,'0')}.json`;

  let TCH_META = null;     // {pageSize, pages, total}
  const TCH_CACHE = new Map(); // 'page-0001' -> {items:[...]}

  async function getMeta(){
    if (TCH_META) return TCH_META;
    TCH_META = await fetch(TCH_META_URL, {cache:'no-cache'}).then(r=>r.json());
    return TCH_META;
  }
  async function getPage(n){
    const key = `page-${String(n).padStart(4,'0')}`;
    if (TCH_CACHE.has(key)) return TCH_CACHE.get(key);
    const data = await fetch(TCH_PAGE_URL(n), {cache:'no-cache'}).then(r=>r.json());
    TCH_CACHE.set(key, data);
    return data;
  }

  // Glob√°lis (0-b√°zis√∫) offset + limit ‚Üí √∂sszev√°logatja a megfelel≈ë JSON-oldalakr√≥l
  async function fetchItems(offset, limit){
    const meta = await getMeta();
    const srcPageSize = meta.pageSize || 300;
    const total = meta.total ?? (meta.pages * srcPageSize);

    const out = [];
    let i = offset;
    while (out.length < limit && i < total){
      const pageNum = Math.floor(i / srcPageSize) + 1;
      const innerIdx = i % srcPageSize;
      const page = await getPage(pageNum);
      const arr = page?.items || [];
      if (innerIdx < arr.length){
        out.push(arr[innerIdx]);
      }
      i++;
      if (arr.length === 0) break;
    }
    return out;
  }

  // K√°rtya render
  function renderCards(root, items){
    root.innerHTML = items.map(it => `
      <div class="card">
        <div class="thumb">
          ${it.img ? `<img src="${it.img}" alt="" loading="lazy" style="max-width:100%;max-height:100%">` : 'üõçÔ∏è'}
        </div>
        <div class="title">${it.title || ''}</div>
        ${it.desc ? `<div class="desc">${it.desc}</div>` : ''}
        <div class="muted">Tchibo${Number.isFinite(it.discount)?` ‚Ä¢ ‚àí${it.discount}%`:''}</div>
        <div class="price">${Number.isFinite(it.price) ? (it.price.toLocaleString('hu-HU') + ' Ft') : (it.price||'')}</div>
        ${it.url ? `<a class="cta" href="${tchiboDl(it.url)}" target="_blank" rel="nofollow sponsored noopener noreferrer">Megn√©zem</a>` : ''}
      </div>
    `).join('');
  }

  // ----- 6/lap (√°ttekint≈ë) -----
  const OVERVIEW_SIZE = 6;
  let overviewPage = 1;

  async function loadTchiboOverview(page=1){
    const meta = await getMeta();
    const total = meta.total ?? (meta.pages * (meta.pageSize||300));
    const offset = (page-1) * OVERVIEW_SIZE;
    const items = await fetchItems(offset, OVERVIEW_SIZE);

    const root = document.getElementById('tchibo-overview-list');
    renderCards(root, items);

    const nav = document.getElementById('tchibo-overview-nav');
    const totalPages = Math.max(1, Math.ceil(total / OVERVIEW_SIZE));
    nav.innerHTML = `
      <button class="chip" ${page<=1?'disabled':''} onclick="loadTchiboOverview(${page-1})">El≈ëz≈ë</button>
      <span class="chip" aria-disabled="true">Oldal ${page} / ${totalPages}</span>
      <button class="chip" ${page>=totalPages?'disabled':''} onclick="loadTchiboOverview(${page+1})">K√∂vetkez≈ë</button>
    `;
    overviewPage = page;
  }

  // ----- 20/lap (Tchibo-n√©zet) -----
  const FULL_SIZE = 20;
  let fullPage = 1;

  async function loadTchiboFull(page=1){
    const meta = await getMeta();
    const total = meta.total ?? (meta.pages * (meta.pageSize||300));
    const offset = (page-1) * FULL_SIZE;
    const items = await fetchItems(offset, FULL_SIZE);

    const root = document.getElementById('tchibo-full-list');
    renderCards(root, items);

    const nav = document.getElementById('tchibo-full-nav');
    const totalPages = Math.max(1, Math.ceil(total / FULL_SIZE));
    nav.innerHTML = `
      <button class="chip" ${page<=1?'disabled':''} onclick="loadTchiboFull(${page-1})">El≈ëz≈ë</button>
      <span class="chip" aria-disabled="true">Oldal ${page} / ${totalPages}</span>
      <button class="chip" ${page>=totalPages?'disabled':''} onclick="loadTchiboFull(${page+1})">K√∂vetkez≈ë</button>
    `;
    fullPage = page;
  }

  // N√©zetv√°lt√°s ugyanazon az oldalon
  function showOverview(){
    document.getElementById('tchibo-overview-list').style.display = '';
    document.getElementById('tchibo-overview-nav').style.display = '';
    document.getElementById('tchibo-full-list').style.display = 'none';
    document.getElementById('tchibo-full-nav').style.display = 'none';
  }
  function showFull(){
    document.getElementById('tchibo-overview-list').style.display = 'none';
    document.getElementById('tchibo-overview-nav').style.display = 'none';
    document.getElementById('tchibo-full-list').style.display = '';
    document.getElementById('tchibo-full-nav').style.display = '';
  }

  // Fejl√©cre kattintva 20/lap n√©zet
  document.addEventListener('DOMContentLoaded', ()=>{
    const tHead = document.getElementById('tchibo-head-link');
    if (tHead){
      tHead.addEventListener('click', (e)=>{
        e.preventDefault();
        showFull();
        loadTchiboFull(1);
        document.getElementById('otthon').scrollIntoView({behavior:'smooth'});
      });
    }

    // indul√°skor: 6/lap √°ttekint≈ë
    showOverview();
    document.getElementById('tchibo-overview-list').innerHTML =
      '<div class="card"><div class="thumb">‚è≥</div><div class="title">T√∂lt√©s‚Ä¶</div></div>';
    loadTchiboOverview(1);
  });
</script>
